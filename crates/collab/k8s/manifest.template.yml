---
apiVersion: v1
kind: Namespace
metadata:
  name: ${ZED_KUBE_NAMESPACE}

---
kind: Service
apiVersion: v1
metadata:
  namespace: ${ZED_KUBE_NAMESPACE}
  name: collab
  annotations:
    service.beta.kubernetes.io/do-loadbalancer-tls-ports: "443"
    service.beta.kubernetes.io/do-loadbalancer-certificate-id: ${ZED_DO_CERTIFICATE_ID}
spec:
  type: LoadBalancer
  selector:
    app: collab
  ports:
    - name: web
      protocol: TCP
      port: 443
      targetPort: 8080

---
kind: Service
apiVersion: v1
metadata:
  namespace: ${ZED_KUBE_NAMESPACE}
  name: pgadmin
  annotations:
    service.beta.kubernetes.io/do-loadbalancer-tls-ports: "443"
    service.beta.kubernetes.io/do-loadbalancer-certificate-id: ${ZED_DO_CERTIFICATE_ID}
spec:
  type: LoadBalancer
  selector:
    app: pgadmin
  ports:
    - name: web
      protocol: TCP
      port: 443
      targetPort: 8080

---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: ${ZED_KUBE_NAMESPACE}
  name: collab

spec:
  replicas: 1
  selector:
    matchLabels:
      app: collab
  template:
    metadata:
      labels:
        app: collab
      annotations:
        ad.datadoghq.com/collab.check_names: |
          ["openmetrics"]
        ad.datadoghq.com/collab.init_configs: |
          [{}]
        ad.datadoghq.com/collab.instances: |
          [
              {
              "openmetrics_endpoint": "http://%%host%%:%%port%%/metrics",
              "namespace": "collab_${ZED_KUBE_NAMESPACE}",
              "metrics": [".*"]
              }
          ]
    spec:
      containers:
        - name: collab
          image: "${ZED_IMAGE_ID}"
          args:
            - serve
          ports:
            - containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 1
            periodSeconds: 1
          env:
            - name: HTTP_PORT
              value: "8080"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: database
                  key: url
            - name: DATABASE_MAX_CONNECTIONS
              value: "${DATABASE_MAX_CONNECTIONS}"
            - name: API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: api
                  key: token
            - name: LIVE_KIT_SERVER
              valueFrom:
                secretKeyRef:
                  name: livekit
                  key: server
            - name: LIVE_KIT_KEY
              valueFrom:
                secretKeyRef:
                  name: livekit
                  key: key
            - name: LIVE_KIT_SECRET
              valueFrom:
                secretKeyRef:
                  name: livekit
                  key: secret
            - name: INVITE_LINK_PREFIX
              value: ${INVITE_LINK_PREFIX}
            - name: RUST_BACKTRACE
              value: "1"
            - name: RUST_LOG
              value: ${RUST_LOG}
            - name: LOG_JSON
              value: "true"
            - name: ZED_ENVIRONMENT
              value: ${ZED_ENVIRONMENT}
          securityContext:
            capabilities:
              # FIXME - Switch to the more restrictive `PERFMON` capability.
              # This capability isn't yet available in a stable version of Debian.
              add: ["SYS_ADMIN"]

---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: ${ZED_KUBE_NAMESPACE}
  name: pgadmin

spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgadmin
  template:
    metadata:
      labels:
        app: pgadmin
    spec:
      securityContext:
        runAsUser: 0
      containers:
        - name: pgadmin
          image: "dpage/pgadmin4"
          ports:
            - containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /misc/ping
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /misc/ping
              port: 8080
            initialDelaySeconds: 1
            periodSeconds: 1
          command: ['/bin/sh', '-c']
          args:
          - |
            set -e

            mkdir -p /var/lib/pgadmin/storage/max_zed.dev

            python3 - <<EOF
            import os
            import json
            from urllib.parse import urlparse;

            url = urlparse(os.environ["ZED_DATABASE_URL"])
            db = url.path[1:]

            with open("/pgadmin4/servers.json", "w") as f:
              f.write(json.dumps({
                "Servers": {
                  "1": {
                      "Name": "Zed Database",
                      "Group": "Server Group 1",
                      "Port": url.port,
                      "Username": url.username,
                      "Host": url.hostname,
                      "SSLMode": "require",
                      "PassFile": "/passfile",
                      "MaintenanceDB": db,
                  }
                }
              }))

            with open("/var/lib/pgadmin/storage/max_zed.dev/passfile", "w") as f:
              f.write(f"*:*:*:*:{url.password}")
            os.chmod("/var/lib/pgadmin/storage/max_zed.dev/passfile", 0o600)
            EOF

            exec /entrypoint.sh

          env:
            - name: PGADMIN_LISTEN_PORT
              value: "8080"
            - name: ZED_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: database
                  key: url
            - name: PGADMIN_CONFIG_WTF_CSRF_CHECK_DEFAULT
              value: "False"
            - name: PGADMIN_DEFAULT_EMAIL
              valueFrom:
                secretKeyRef:
                  name: pgadmin
                  key: email
            - name: PGADMIN_DEFAULT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: pgadmin
                  key: password
