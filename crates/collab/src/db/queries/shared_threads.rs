use super::*;

impl Database {
    /// Create a new shared thread and return its ID.
    /// The ID is auto-generated by the database.
    pub async fn create_shared_thread(
        &self,
        user_id: UserId,
        title: &str,
        data: Vec<u8>,
    ) -> Result<SharedThreadId> {
        let title = title.to_string();
        self.transaction(|tx| {
            let title = title.clone();
            let data = data.clone();
            async move {
                let model = shared_thread::ActiveModel {
                    user_id: ActiveValue::Set(user_id),
                    title: ActiveValue::Set(title),
                    data: ActiveValue::Set(data),
                    ..Default::default()
                }
                .insert(&*tx)
                .await?;

                Ok(model.id)
            }
        })
        .await
    }

    /// Get a shared thread by ID.
    pub async fn get_shared_thread(
        &self,
        share_id: SharedThreadId,
    ) -> Result<Option<(shared_thread::Model, String)>> {
        self.transaction(|tx| async move {
            let Some(thread) = shared_thread::Entity::find_by_id(share_id)
                .one(&*tx)
                .await?
            else {
                return Ok(None);
            };

            let user = user::Entity::find_by_id(thread.user_id).one(&*tx).await?;

            let username = user
                .map(|u| u.github_login)
                .unwrap_or_else(|| "Unknown".to_string());

            Ok(Some((thread, username)))
        })
        .await
    }
}
