# TOP PRIORITY: Fix Failing Tests

## Summary
21 tests failing after scheduler integration changes. The root cause is timing issues
with the new scheduler where tests use fake LSP servers before registration is complete.

## Fix Strategy

Based on recent commits (efe540f2da, 3286eed6ed), the pattern is:
**Add `cx.run_until_parked()` after `fake_servers.next().await.unwrap()`**

This ensures the language server is fully registered with the buffer before tests proceed.

Example fix pattern:
```rust
let fake_server = fake_servers.next().await.unwrap();
cx.run_until_parked();  // <-- ADD THIS LINE
```

Or in contexts with `cx.executor()`:
```rust
let fake_server = fake_servers.next().await.unwrap();
cx.executor().run_until_parked();  // <-- ADD THIS LINE
```

## Failing Tests (18)

### project crate (9 tests) - HIGHEST PRIORITY
- [ ] `project_tests::test_apply_code_actions_with_commands`
- [ ] `project_tests::test_completions_with_carriage_returns`
- [x] `project_tests::test_completions_with_text_edit`
- [ ] `project_tests::test_completions_with_edit_ranges`
- [ ] `project_tests::test_completions_without_edit_ranges`
- [x] `project_tests::test_definition`
- [ ] `project_tests::test_lsp_rename_notifications`
- [ ] `project_tests::test_rename`
- [ ] `project_tests::test_reporting_fs_changes_to_language_servers`
- [ ] `project_tests::test_restarting_server_with_diagnostics_running`

### collab crate (4 tests)
- [ ] `tests::editor_tests::test_language_server_statuses`
- [ ] `tests::integration_tests::test_collaborating_with_lsp_progress_updates_and_diagnostics_ordering`
- [ ] `tests::integration_tests::test_formatting_buffer`
- [ ] `tests::integration_tests::test_project_symbols`

### Other crates (5 tests)
- [ ] `extension_host extension_store_test::test_extension_store_with_test_extension`
- [ ] `project_panel project_panel_tests::test_drag_marked_entries_in_folded_directories`
- [ ] `terminal tests::test_terminal_no_exit_on_spawn_failure`
- [ ] `workspace tests::test_moving_items_can_clone_panes`

## Interrupted Tests (3)
These may also need the same fix or have other timing issues:
- [ ] `project project_tests::test_file_status`
- [ ] `editor editor_tests::test_multiline_completion`
- [ ] `editor editor_tests::test_html_linked_edits_on_completion`

## Files to Modify

1. `crates/project/src/project_tests.rs` - Most failing tests are here
2. `crates/collab/src/tests/editor_tests.rs`
3. `crates/collab/src/tests/integration_tests.rs`
4. `crates/extension_host/src/extension_store_test.rs`
5. `crates/project_panel/src/project_panel_tests.rs`
6. `crates/terminal/src/tests.rs`
7. `crates/workspace/src/tests.rs`
8. `crates/editor/src/editor_tests.rs`

## Related Commits
- efe540f2da: Fixed EditorLspTestContext with run_until_parked after server connects
- 3286eed6ed: Fixed test_completion_can_run_commands and test_completion_in_multibuffer_with_replace_range
- 8f961a41c6: Made all foreground tasks drop when app dies (root cause of timing changes)
