name: Identify potential duplicates among new bug/crash reports

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to analyze (for testing)"
        required: true
        type: number

concurrency:
  group: potential-duplicate-check-${{ github.event.issue.number || inputs.issue_number }}
  # let's not overspend tokens on multiple parallel checks of the same issue
  cancel-in-progress: true

jobs:
  identify-duplicates:
    if: github.repository == 'zed-industries/zed'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: read
      id-token: write

    steps:
      - name: Get github app token
        id: get-app-token
        uses: actions/create-github-app-token@bef1eaf1c0ac2b148ee2a0a74c65fbe6db0631f1 # v2.1.4
        with:
          app-id: ${{ secrets.ZED_COMMUNITY_BOT_APP_ID }}
          private-key: ${{ secrets.ZED_COMMUNITY_BOT_PRIVATE_KEY }}
          owner: zed-industries

      - name: Check issue type
        id: check-type
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ steps.get-app-token.outputs.token }}
          script: |
            const issueNumber = context.payload.issue?.number || ${{ inputs.issue_number || 0 }};
            if (!issueNumber) {
              core.setFailed('No issue number provided');
              return;
            }

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const typeName = issue.type?.name;
            const isTargetType = typeName === 'Bug' || typeName === 'Crash';

            console.log(`Issue #${issueNumber}: "${issue.title}"`);
            console.log(`Issue type: ${typeName || '(none)'}`);
            console.log(`Is target type (Bug/Crash): ${isTargetType}`);

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_author', issue.user?.login || '');
            core.setOutput('is_target_type', isTargetType);

            if (!isTargetType) {
              console.log('::notice::Skipping - issue type is not Bug or Crash');
            }

      - name: Check if author is staff
        if: steps.check-type.outputs.is_target_type == 'true'
        id: check-staff
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ steps.get-app-token.outputs.token }}
          script: |
            const author = process.env.ISSUE_AUTHOR || '';
            if (!author) {
              console.log('Could not determine issue author, proceeding with check');
              core.setOutput('is_staff', 'false');
              return;
            }

            try {
              const response = await github.rest.teams.getMembershipForUserInOrg({
                org: 'zed-industries',
                team_slug: 'staff',
                username: author
              });
              const isStaff = response.data.state === 'active';
              core.setOutput('is_staff', String(isStaff));
              if (isStaff) {
                console.log(`::notice::Skipping - author @${author} is a staff member`);
              }
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('is_staff', 'false');
              } else {
                throw error;
              }
            }
        env:
          ISSUE_AUTHOR: ${{ steps.check-type.outputs.issue_author }}

      - name: Checkout repository
        if: |
          steps.check-type.outputs.is_target_type == 'true' &&
          steps.check-staff.outputs.is_staff == 'false'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Minimal test - fetch single issue (DEBUG)
        if: |
          steps.check-type.outputs.is_target_type == 'true' &&
          steps.check-staff.outputs.is_staff == 'false'
        id: analyze
        timeout-minutes: 5
        uses: anthropics/claude-code-action@231bd75b7196d48291c1498f1c6d277c2810d9a3 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY_ISSUE_DEDUP }}
          github_token: ${{ steps.get-app-token.outputs.token }}
          # this is automatic analysis, not user-invoked, and Claude only has read-only tools, so should be safe
          allowed_non_write_users: "*"
          # enable full output to debug the hang
          show_full_output: true

          prompt: |
            Fetch issue #${{ steps.check-type.outputs.issue_number }} from zed-industries/zed using mcp__github__get_issue and tell me its title.

          claude_args: |
            --max-turns 1
            --allowedTools mcp__github__get_issue,mcp__github__search_issues,mcp__github__list_issues

      - name: Log analysis results
        if: |
          steps.check-type.outputs.is_target_type == 'true' &&
          steps.check-staff.outputs.is_staff == 'false' &&
          !cancelled()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const output = process.env.ANALYSIS_OUTPUT || '(no structured_output)';
            const conclusion = process.env.ANALYSIS_CONCLUSION || '(no conclusion)';

            console.log('='.repeat(60));
            console.log('DEBUG: RAW OUTPUT FROM CLAUDE');
            console.log('='.repeat(60));
            console.log('structured_output:', output);
            console.log('');
            console.log('conclusion:', conclusion);
            console.log('='.repeat(60));
        env:
          ANALYSIS_OUTPUT: ${{ steps.analyze.outputs.structured_output }}
          ANALYSIS_CONCLUSION: ${{ steps.analyze.outputs.conclusion }}
